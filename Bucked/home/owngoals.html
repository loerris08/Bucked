<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Bucked</title>
  <link rel="stylesheet" href="style.css">
  <link rel="stylesheet" href="style2.css">
</head>

<body>
  <div class="standard">
    <nav class="menu menu1">
      <input type='checkbox' onclick='updatemenu()'><label></label>
      <ul>
        <li><a href='aahome.html'>üèö</a></li>
        <li class="bucked2">Bucked</li>
        <li><a href='profile.html'><img class="picture" src="profilepicture.png"></a></li>
      </ul>
    </nav>


    <div id="recentactivity" style="display: table-column; font-size: 30px;"></div>


    <nav class="menu menu2">
      <input type='checkbox' id='responsive-menu' onclick='updatemenu()'><label></label>
      <ul>
        <li><a href='owngoals.html'>üìù</a></li>
        <li><a href='addgoal.html' style="font-size: 95px;">+</a></li>
        <li><a href='discover.html'>üîé</a></li>
      </ul>
    </nav>

  </div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js";
  import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-auth.js";
  import { getFirestore, collection, query, where, getDocs, deleteDoc, doc, getDoc, setDoc, updateDoc, increment } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-firestore.js";
  import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-analytics.js";

  // --- Firebase Config ---
  const firebaseConfig = {
    apiKey: "AIzaSyDahPBRsjOGgalkR3raXagtKytGn9n1SdE",
    authDomain: "bucked.firebaseapp.com",
    projectId: "bucked",
    storageBucket: "bucked.firebasestorage.app",
    messagingSenderId: "83783824498",
    appId: "1:83783824498:web:da41e3e5dfbe131441beeb",
    measurementId: "G-F3VYK204YW"
  };

  // --- Firebase initialisieren ---
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);
  const analytics = getAnalytics(app);

  window.auth = auth;
  window.db = db;

  const recentDiv = document.getElementById("recentactivity");
  const usernameDisplay = document.getElementById("usernameDisplay");


function makeCatId(cat) {
  return String(cat || "")
    .toLowerCase()
    .normalize("NFD")
    .replace(/[\u0300-\u036f]/g, "")
    .replace(/\s+/g, "-")
    .replace(/[^\w-]/g, "")
    .replace(/-+/g, "-")
    .replace(/^-|-$/g, "");
}

  // --- Username laden ---
  async function loadUsername() {
    const user = auth.currentUser;
    if (!user) return "User2000";
    const docSnap = await getDoc(doc(db, "users", user.uid));
    return docSnap.exists() ? docSnap.data().username : "User2000";
  }

  // --- Eigene Goals laden ---
  async function loadGoals() {
    const user = auth.currentUser;
    if (!user) return;

    const q = query(collection(db, "goals"), where("uid", "==", user.uid));
    const querySnapshot = await getDocs(q);

    recentDiv.innerHTML = "";

    if (querySnapshot.empty) {
      recentDiv.textContent = "No goals yet. Add one!";
      return;
    }

    // Alle Goals ins Array sammeln
    const goals = [];
    querySnapshot.forEach(docSnap => {
      goals.push({ id: docSnap.id, ...docSnap.data() });
    });

    // Kategorien in gew√ºnschter Reihenfolge
    const categoryOrder = [
      "SportüèÄ", "Studyüìñ", "HobbyüéÆ", "Healthü•º",
      "Financeüí∞", "Travel‚úàÔ∏è", "Artüé®", "Socialü§ù", "Other‚ùì"
    ];

  // Sortieren: erst nach Kategorie, dann nach completed
  goals.sort((a, b) => {
    const indexA = categoryOrder.indexOf(a.category);
    const indexB = categoryOrder.indexOf(b.category);

    // Nach Kategorie
    if (indexA !== indexB) {
      return indexA - indexB;
    }

    // Innerhalb der Kategorie: offene zuerst, completed nach unten
    if (a.completed === b.completed) return 0;
    return a.completed ? 1 : -1;
  });

// Jetzt in Reihenfolge anzeigen
goals.forEach(goal => {
  const box = document.createElement("div");
  box.classList.add("goal-box");

  // Hintergrundfarbe je nach Public/Private
  box.classList.add(goal.public ? "goal-public" : "goal-private");

  // Kategorie
  const categoryEl = document.createElement("span");
  categoryEl.classList.add("goal-category");
  categoryEl.dataset.category = makeCatId(goal.category);
  categoryEl.textContent = goal.category;

  // Titel
  const titleEl = document.createElement("span");
  titleEl.classList.add("goal-title");
  titleEl.textContent = goal.title;

  // Textcontainer
  const text = document.createElement("div");
  text.classList.add("goal-text");
  text.appendChild(categoryEl);
  text.appendChild(document.createTextNode(" : "));
  text.appendChild(titleEl);

  // Falls Ziel erledigt ist ‚Üí durchstreichen
  if (goal.completed) {
    titleEl.style.textDecoration = "line-through";
    box.style.backgroundColor = "rgba(0, 128, 0, 0.2)";
  }

  // Aktionen-Container
  const actions = document.createElement("div");
  actions.classList.add("goal-actions");

// ‚úÖ / ‚≠ïÔ∏è Button
const tickBtn = document.createElement("a");
tickBtn.textContent = goal.completed ? "‚úÖ" : "‚≠ïÔ∏è";
tickBtn.classList.add("tick-btn");

tickBtn.onclick = async () => {
  const newCompleted = !goal.completed;

  // Goal selbst updaten
  await updateDoc(doc(db, "goals", goal.id), {
    completed: newCompleted
  });

  // Benutzer pr√ºfen
  const user = auth.currentUser;
  if (!user) return;

  const statsRef = doc(db, "stats", user.uid);

  // Pr√ºfen, ob Stats-Dokument existiert ‚Äì wenn nicht, anlegen
  const statsSnap = await getDoc(statsRef);
  if (!statsSnap.exists()) {
    await updateDoc(statsRef, { uid: user.uid, xplevel: 0, completedGoals: 0, pendingGoals: 0 })
      .catch(async () => {
        // Falls updateDoc scheitert, weil Dokument fehlt, setDoc verwenden
        await setDoc(statsRef, { uid: user.uid, xplevel: 0, completedGoals: 0, pendingGoals: 0 });
      });
  }

  // Jetzt sicher updaten
  if (newCompleted) {
    await updateDoc(statsRef, {
      pendingGoals: increment(-1),
      completedGoals: increment(1),
      xplevel: increment(10),
    });
  } else {
    await updateDoc(statsRef, {
      pendingGoals: increment(1),
      completedGoals: increment(-1),
      xplevel: increment(-10)
    });
  }

  loadGoals(); // UI neu laden
};

  // üìù Edit
  const editBtn = document.createElement("a");
  editBtn.textContent = "üìù";
  editBtn.classList.add("edit-btn");
  editBtn.href = "#";
  editBtn.onclick = (e) => {
    e.preventDefault();
    openEditForm(goal.id, goal);
  };

// ‚ùå Remove
const removeBtn = document.createElement("button");
removeBtn.textContent = "‚ùå";
removeBtn.classList.add("remove-btn");

removeBtn.onclick = async () => {
  await deleteDoc(doc(db, "goals", goal.id));
  await updateDoc(doc(db, "stats", "basis"), {
    pendingGoals: !goal.completed ? increment(-1) : increment(0),
    publicGoals: goal.public ? increment(-1) : increment(0),
    privateGoals: !goal.public ? increment(-1) : increment(0),
    deletedGoals: increment(1),
    totalGoals: increment(0),
    completedGoals: goal.completed ? increment(-1) : increment(0),
    xplevel: goal.completed ? increment(-10) : increment(0)   ////////////////////////////////////////////////////////////////
  });
  await updateDoc(doc(db, "stats", user.uid),{
    xplevel: goal.completed ? increment(-10) : increment(0)
  });
  loadGoals();
};

  actions.appendChild(tickBtn);
  actions.appendChild(editBtn);
  actions.appendChild(removeBtn);

  box.appendChild(text);
  box.appendChild(actions);

  recentDiv.appendChild(box);
});
  }



// --- Bearbeitungsformular ---
async function openEditForm(goalId, goal) {
  const form = document.createElement("div");
  form.classList.add("edit-form");

  form.innerHTML = `
    <label>Kategorie: <input type="text" id="edit-category" value="${goal.category}" maxlength="16"></label><br>
    <label>Titel: <input type="text" id="edit-title" value="${goal.title}" maxlength="16"></label><br>
    <label>Deadline: <input type="date" id="edit-deadline" value="${goal.deadline || ""}"></label><br><p></p>
    <div id="button-group">
      <button type="button" class="toggle-btn2 ${goal.public ? "active" : ""}">Public</button>
      <button type="button" class="toggle-btn2 ${!goal.public ? "active" : ""}">Private</button>
    </div>
    <p></p>
    <div id="centerbuttons">
      <button id="saveEdit" class="button2">Speichern</button>
      <button id="cancelEdit" class="button2">Abbrechen</button>
    </div>
  `;

document.body.appendChild(form);

  // --- Public/Private Toggle ---
  let isPublic = goal.public ?? true;
  const toggleButtons = form.querySelectorAll('.toggle-btn2');
  toggleButtons.forEach(btn => {
    btn.addEventListener('click', function () {
      toggleButtons.forEach(b => b.classList.remove('active'));
      this.classList.add('active');
      isPublic = this.textContent.trim() === "Public";
    });
  });

  // --- Speichern ---
  document.getElementById("saveEdit").onclick = async () => {
    const updatedGoal = {
      category: document.getElementById("edit-category").value,
      title: document.getElementById("edit-title").value,
      deadline: document.getElementById("edit-deadline").value,
      public: isPublic
    };

const user = auth.currentUser;
if (!user) return;
const statsRef = doc(db, "stats", user.uid);

    // Stats nur updaten, wenn sich Public/Private ge√§ndert hat
    if (goal.public !== isPublic) {
      if (goal.public && !isPublic) {
        // Public -> Private
        await updateDoc(statsRef, {
          publicGoals: increment(-1),
          privateGoals: increment(1)
        });
      } else if (!goal.public && isPublic) {
        // Private -> Public
        await updateDoc(statsRef, {
          publicGoals: increment(1),
          privateGoals: increment(-1)
        });
      }
    }

    // Goal in Firestore aktualisieren
    await updateDoc(doc(db, "goals", goalId), updatedGoal);

    form.remove();
    loadGoals();
  };

  // --- Abbrechen ---
  document.getElementById("cancelEdit").onclick = () => {
    form.remove();
  };
}
  // --- Auth Check + Username laden ---
  onAuthStateChanged(auth, async user => {
    if (!user) {
      window.location.href = "../pre/login.html";
    } else {
      const username = await loadUsername();
      if (usernameDisplay) usernameDisplay.textContent = username;
      loadGoals();
    }
  });
  
  
</script>







</body>


</html>